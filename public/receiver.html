<button onclick="init()">Ativar áudio</button>

<script>
let ctx;
let lastSeq = 0; // ← controla EVENTO, não valor

function init() {
  ctx = new (window.AudioContext || window.webkitAudioContext)();
  setInterval(check, 800);
}

function beep() {
  const o = ctx.createOscillator();
  o.frequency.value = 800;
  o.connect(ctx.destination);
  o.start();
  setTimeout(() => o.stop(), 120);
}

async function play(n) {
  for (let i = 0; i < n; i++) {
    beep();
    await new Promise(r => setTimeout(r, 250));
  }
}

async function check() {
  const r = await fetch('/api/beep');
  const j = await r.json();

  // só toca se for um ENVIO novo
  if (j.seq !== lastSeq) {
    lastSeq = j.seq;
    play(j.count);
  }
}
</script>
